# .github/workflows/deploy-cloudways.yml
name: Build & Deploy to Cloudways

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cloudways-deploy
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    ############################################################
    # 1 CHECK OUT CODE & BUILD
    ############################################################
    - uses: actions/checkout@v4

    - uses: pnpm/action-setup@v4
      with: { version: 9 }

    - uses: actions/setup-node@v4
      with:
        node-version-file: .nvmrc
        cache: pnpm

    - name: Install deps
      run: pnpm install --frozen-lockfile

    - name: Build Next.js
      run: pnpm build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_TINA_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_TINA_CLIENT_ID }}
        NEXT_PUBLIC_TINA_BRANCH:   ${{ github.ref_name }}
        TINA_TOKEN:                ${{ secrets.TINA_TOKEN }}

    ############################################################
    # 2 UPLOAD WORKSPACE (INCLUDING .next/) TO CLOUDWAYS
    ############################################################
    - name: Install rsync & sshpass
      run: sudo apt-get update -y && sudo apt-get install -y rsync sshpass

    - name: Rsync workspace to Cloudways
      env:
        SSHPASS: ${{ secrets.CLOUDWAYS_PASSWORD }}
      run: |
        rsync -avz --delete \
          --exclude '.git' \
          --exclude '.github' \
          --exclude 'node_modules' \
          --exclude '.env*' \
          --no-perms --omit-dir-times \
          -e "sshpass -e ssh -o StrictHostKeyChecking=no -p 22" \
          ./ \
          ${{ secrets.CLOUDWAYS_USERNAME }}@${{ secrets.CLOUDWAYS_HOST }}:/home/master/applications/letterbox/public_html/

    ############################################################
    # 3 INSTALL PROD DEPENDENCIES & RELOAD PM2
    ############################################################
    - name: Install deps & reload on Cloudways
      uses: appleboy/ssh-action@master
      with:
        host:       ${{ secrets.CLOUDWAYS_HOST }}
        username:   ${{ secrets.CLOUDWAYS_USERNAME }}
        password:   ${{ secrets.CLOUDWAYS_PASSWORD }}
        port: 22
        script: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          nvm use 18

          cd /home/master/applications/letterbox/public_html

          echo "Installing production dependencies…"
          npm ci --omit=dev        # <-- installs node_modules on the server

          if ! command -v pm2 >/dev/null 2>&1; then
            npm install -g pm2
          fi

          pm2 reload tina-app || pm2 start npm --name "tina-app" -- start
          pm2 save
