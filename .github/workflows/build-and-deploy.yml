name: Build & Deploy to Cloudways

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: pm
        run: |
          if [ -f yarn.lock ]; then echo "pm=yarn" >> $GITHUB_OUTPUT
          elif [ -f pnpm-lock.yaml ]; then echo "pm=pnpm" >> $GITHUB_OUTPUT
          else echo "pm=npm" >> $GITHUB_OUTPUT; fi

      - if: steps.pm.outputs.pm == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: ${{ steps.pm.outputs.pm }}

      - name: Install dependencies
        run: |
          if [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then yarn install --immutable;
          elif [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then pnpm install --frozen-lockfile;
          else npm ci; fi

      - name: Build Next.js app
        run: |
          if [ "${{ steps.pm.outputs.pm }}" = "yarn" ]; then yarn build;
          elif [ "${{ steps.pm.outputs.pm }}" = "pnpm" ]; then pnpm build;
          else npx --no-install next build; fi
        env:
          NODE_ENV: production
          NEXT_PUBLIC_TINA_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_TINA_CLIENT_ID }}
          NEXT_PUBLIC_TINA_BRANCH:   ${{ github.ref_name }}
          TINA_TOKEN:                ${{ secrets.TINA_TOKEN }}

      - name: Upload build to Cloudways
        env:
          SSHPASS: ${{ secrets.CLOUDWAYS_PASSWORD }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass rsync
          rsync -avz --delete \
            -e "sshpass -e ssh -o StrictHostKeyChecking=no -p 22" \
            .next public package.json pnpm-lock.yaml \
            ${{ secrets.CLOUDWAYS_USERNAME }}@${{ secrets.CLOUDWAYS_HOST }}:/home/1404939.cloudwaysapps.com/mzzbgxcybr/public_html/

      - name: Reload PM2 on Cloudways
        uses: appleboy/ssh-action@master
        with:
          host:       ${{ secrets.CLOUDWAYS_HOST }}
          username:   ${{ secrets.CLOUDWAYS_USERNAME }}
          password:   ${{ secrets.CLOUDWAYS_PASSWORD }}
          port: 22
          timeout: 600s
          script: |
            cd /home/1404939.cloudwaysapps.com/mzzbgxcybr/public_html
            git config --global --add safe.directory /home/1404939.cloudwaysapps.com/mzzbgxcybr/public_html
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 18
            if ! command -v pm2 >/dev/null 2>&1; then npm install -g pm2; fi
            pm2 reload tina-app || pm2 start npm --name "tina-app" -- start
            pm2 save
