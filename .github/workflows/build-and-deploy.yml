name: Build and Deploy to Cloudways

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build app
        run: pnpm build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_TINA_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_TINA_CLIENT_ID }}
          NEXT_PUBLIC_TINA_BRANCH: ${{ github.ref_name }}
          TINA_TOKEN: ${{ secrets.TINA_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: SSH into Cloudways and pull + restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CLOUDWAYS_HOST }}
          username: ${{ secrets.CLOUDWAYS_USERNAME }}
          password: ${{ secrets.CLOUDWAYS_PASSWORD }}  # or use `key` and `passphrase`
          port: 22
          script: |
            # 1 – go to the app folder
            cd /home/1404939.cloudwaysapps.com/mzzbgxcybr/public_html
          
            # 2 – make Git happy about folder ownership
            git config --global --add safe.directory /home/1404939.cloudwaysapps.com/mzzbgxcybr/public_html
          
            # 3 – pull latest commit
            git pull origin main --ff-only
          
            # 4 – load Node via nvm (adjust version if your .nvmrc is different)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 18
          
            # 5 – install PM2 globally the first time, skip if already present
            command -v pm2 >/dev/null 2>&1 || npm install -g pm2
          
            # 6 – reload (or start) the PM2 process
            pm2 reload tina-app || pm2 start npm --name "tina-app" -- start
            pm2 save

