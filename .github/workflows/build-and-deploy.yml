name: Build and Deploy to Cloudways

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build app
        run: pnpm build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_TINA_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_TINA_CLIENT_ID }}
          NEXT_PUBLIC_TINA_BRANCH: ${{ github.ref_name }}
          TINA_TOKEN: ${{ secrets.TINA_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: SSH into Cloudways and pull + restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CLOUDWAYS_HOST }}
          username: ${{ secrets.CLOUDWAYS_USERNAME }}
          password: ${{ secrets.CLOUDWAYS_PASSWORD }}  # or use `key` and `passphrase`
          port: 22
          script: |
            cd /home/master/applications/letterbox/public_html
            git config --global --add safe.directory /home/master/applications/letterbox/public_html
            git pull origin main
          
            export NVM_DIR="$HOME/.nvm"
            source "$NVM_DIR/nvm.sh"
            source "$NVM_DIR/bash_completion"
            nvm use 18
          
            pm2 reload tina-app || pm2 start npm --name "tina-app" -- start
            pm2 save
